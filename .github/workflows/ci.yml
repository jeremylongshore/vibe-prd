name: CI
on: [push, pull_request]

jobs:
  test-containerized-cli:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build container
        run: |
          echo "ğŸ³ Building containerized CLI..."
          docker build -t ai-dev-tasks-test .

      - name: Test container help command
        run: |
          echo "ğŸ§ª Testing container help command..."
          docker run --rm ai-dev-tasks-test make help

      - name: Test container status command
        run: |
          echo "ğŸ§ª Testing container status command..."
          docker run --rm ai-dev-tasks-test make status

      - name: Test template availability
        run: |
          echo "ğŸ§ª Testing template availability..."
          docker run --rm ai-dev-tasks-test bash -c "ls -la templates/ | wc -l"

      - name: Test document creation
        run: |
          echo "ğŸ§ª Testing document creation..."
          mkdir -p test-workspace
          docker run --rm -v "$PWD/test-workspace":/workspace -w /workspace ai-dev-tasks-test make create T=create-prd.md N=test-prd.md
          [ -f "test-workspace/test-prd.md" ] || { echo "âŒ Document not created"; exit 1; }
          echo "âœ… Document creation works"

      - name: Verify core files exist
        run: |
          echo "ğŸ§ª Verifying core files..."
          required_files=(
            "Dockerfile"
            "ai-dev"
            "Makefile"
            "professional-templates"
            "README.md"
            "CHANGELOG.md"
          )

          for file in "${required_files[@]}"; do
            [ -e "$file" ] || { echo "âŒ Missing required file: $file"; exit 1; }
            echo "âœ… $file exists"
          done

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Shellcheck setup scripts
        run: |
          if [ -d "setup-scripts" ]; then
            shellcheck setup-scripts/*.sh
          else
            echo "â„¹ï¸ No setup-scripts directory found, skipping shellcheck"
          fi

      - name: Shellcheck ai-dev wrapper
        run: shellcheck ai-dev