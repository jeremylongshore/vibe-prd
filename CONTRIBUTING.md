# Contributor SOP — vibe-prd

## Ground rules
- No sudo. Ever.
- Containers run as your UID/GID.
- Outputs live only in docs/bmad/ and docs/templates/.
- End state = BMAD natives + 22 templates. Not 44.

## Local setup

```bash
git clone https://github.com/jeremylongshore/vibe-prd
cd vibe-prd
make ai-dev     # fill brief (interactive)
make prd        # generate BMAD + 22 templates
```

Expect:
- docs/bmad/ contains BMAD-native files.
- docs/templates/ contains exactly 22 files.

## Branch + commit
- Branch: feat/<slug>, fix/<slug>, or chore/<slug>.
- Commits: Conventional Commits.
  - `feat: add extraction for personas`
  - `fix: run container with uid:gid`
  - `chore: bump BMAD 5.1.4`

## PR checklist (must pass)
- ✅ `make prd` succeeds locally.
- ✅ docs/bmad/ exists.
- ✅ docs/templates/ has 22 files. Names match map.yaml.
- ✅ No root-owned files (ls -l shows your user).
- ✅ CI: "Container CI" green.

## CI gates (what runs)
- Build CLAUDE brief demo.
- `make prd`.
- Verify:
  - docs/bmad/ exists.
  - docs/templates/ count == 22 and names match.
- Fails fast on mismatch.

## Auto-updates (BMAD)
- Renovate checks daily.
- New BMAD tag → PR bumps .bmad-version and refreshes .bmad-lock.
- CI must pass. Auto-merge enabled.
- You do nothing.

## Manual BMAD bump (rare)

```bash
sed -i 's/bmad:5.1.3/bmad:5.1.4/' .bmad-version
make bmad-lock
git add .bmad-version .bmad-lock
git commit -m "bump: BMAD 5.1.4"
git push
```

## Release flow

```bash
# after merge to main
git pull
git tag vX.Y.Z
git push origin vX.Y.Z
# GitHub Actions creates a Release with artifacts
```

## File ownership fix (if you break it)

```bash
make fix-perms
# or:
docker run --rm -v "$PWD":/work alpine:3.20 \
  sh -c "chown -R $(id -u):$(id -g) /work/docs 2>/dev/null || true"
```

## Working directory rule
- Work in repo root.
- In workflows, set:
  ```yaml
  defaults:
    run:
      working-directory: ./
  ```
- In manual runs, `cd /path/to/vibe-prd` before commands.

## Directory layout

```
vibe-prd/
  cli.js                  # form → CLAUDE.md
  questions.yaml
  map.yaml                # 22 template filenames
  templates/              # your 22 templates
  collect-bmad.js         # normalize BMAD outputs
  extract-bmad.js         # BMAD → summary.json
  fill-templates.js       # summary.json → 22 docs
docs/
  bmad/                   # BMAD natives (source of truth)
  templates/              # 22 filled docs (user-facing)
vibe-prd/
  CLAUDE.template.md
  CLAUDE.md               # generated by form
.bmad-version             # container tag
.bmad-lock                # container digest
Makefile                  # all commands
```

## Makefile targets (what to run)

- `make ai-dev` - interactive form → CLAUDE.md
- `make prd` - BMAD run + collect + extract + fill + verify
- `make clean-docs` - reset docs folders
- `make fix-perms` - fix ownership if needed

## Troubleshooting
- **Template count < 22**: Check map.yaml names. Ensure matching files in templates/.
- **BMAD natives missing**: Container tag wrong. Update .bmad-version, then `make bmad-lock`.
- **Permission denied**: Run `make fix-perms`. Ensure Makefile uses `-u $(id -u):$(id -g)`.
- **Claude "cwd reset"**: Always set working-directory in workflows or cd before commands.

## PR commands (fast path)

```bash
git checkout -b feat/<slug>
git add -A
git commit -m "feat: <what you changed>"
git push -u origin feat/<slug>
gh pr create --fill
gh pr checks --watch
gh pr merge --squash --delete-branch   # when green
```

## Non-negotiables
- Do not use sudo.
- Do not write to output/. Use docs/bmad and docs/templates only.
- Do not promise "44 docs." Deliver BMAD natives + 22 templates.
- Do not bypass CI gates.

---

**Done. Users will cruise.**